<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Form Pemesanan Periklanan - Lead Digital Marketing</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Watermark style for preview/invoice */
    .invoice-wrap {
      position: relative;
      padding: 2rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.06);
    }
    .watermark {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) rotate(-25deg);
      font-size: 72px;
      color: rgba(0,0,0,0.06);
      pointer-events: none;
      user-select: none;
      white-space: nowrap;
    }
    /* Invoice layout */
    .invoice-header { display:flex; justify-content:space-between; align-items:center }
    .small-muted { color: #666; font-size: 0.9rem }
    /* Make printed PDF look better */
    @media print {
      body { background: #fff }
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4">Form Pemesanan Periklanan - <small class="text-muted">Lead Digital Marketing</small></h1>

    <div class="card mb-4">
      <div class="card-body">
        <form id="orderForm" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Pemesanan</label>
            <input type="text" id="nama" class="form-control" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Paket Iklan (input manual)</label>
            <input type="text" id="paket" class="form-control" placeholder="Contoh: Paket A - Leads" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Budget Iklan Harian (min 17.000)</label>
            <input type="number" id="budget" class="form-control" min="17000" value="17000" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Durasi Tayang (hari) (min 3)</label>
            <input type="number" id="durasi" class="form-control" min="3" value="3" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Jasa Setup (otomatis)</label>
            <input type="text" id="jasaSetupText" class="form-control" readonly>
          </div>

          <div class="col-md-6">
            <label class="form-label">Total Biaya Iklan (otomatis)</label>
            <input type="text" id="totalIklanText" class="form-control" readonly>
          </div>

          <div class="col-md-6">
            <label class="form-label">Total Keseluruhan (otomatis)</label>
            <input type="text" id="totalAllText" class="form-control" readonly>
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="showWatermark" checked>
              <label class="form-check-label" for="showWatermark">Tampilkan watermark "Lead Digital Marketing" pada preview/pdf</label>
            </div>
          </div>

          <div class="col-12 d-flex gap-2">
            <button type="button" id="btnPreview" class="btn btn-primary">Tampilkan Form Pesanan (Preview)</button>
            <button type="button" id="btnDownloadPdf" class="btn btn-success">Download PDF (compress)</button>
            <button type="button" id="btnShare" class="btn btn-outline-primary">Share</button>
            <button type="reset" class="btn btn-secondary">Reset</button>
          </div>
        </form>
      </div>
    </div>

    <div id="previewArea" class="mb-5" style="display:none">
      <div class="invoice-wrap" id="invoice">
        <div class="watermark" id="wmText">Lead Digital Marketing</div>

        <div class="invoice-header mb-3">
          <div>
            <h4 class="mb-0">Lead Digital Marketing</h4>
            <div class="small-muted">Form Pemesanan Periklanan</div>
          </div>
          <div class="text-end">
            <strong>Invoice</strong>
            <div id="invoiceNumber">#0000</div>
            <div class="small-muted" id="tanggalInvoice"></div>
          </div>
        </div>

        <hr>

        <div class="row mb-3">
          <div class="col-sm-6">
            <div><strong>Nama Pemesanan</strong></div>
            <div id="pvNama"></div>
            <div class="small-muted mt-2">Paket Iklan</div>
            <div id="pvPaket"></div>
          </div>

          <div class="col-sm-6 text-sm-end">
            <div class="small-muted">Budget Iklan Harian</div>
            <div id="pvBudget"></div>
            <div class="small-muted mt-2">Durasi Tayang</div>
            <div id="pvDurasi"></div>
          </div>
        </div>

        <table class="table table-borderless">
          <tbody>
            <tr>
              <td>Subtotal (Budget harian Ã— Durasi)</td>
              <td class="text-end" id="pvSubtotal"></td>
            </tr>
            <tr>
              <td>Jasa Setup</td>
              <td class="text-end" id="pvJasa"></td>
            </tr>
            <tr>
              <th>Total Keseluruhan</th>
              <th class="text-end" id="pvTotal"></th>
            </tr>
          </tbody>
        </table>

        <div class="small-muted">Catatan: Jasa setup dihitung mulai pada durasi 3 hari = 50.000. Jika durasi lebih dari 3 hari, tambahan Rp 15.000 per hari di atas 3 hari.</div>

      </div>
    </div>

    <div class="text-muted small">Generated by Lead Digital Marketing - Form Pemesanan</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Helper: format number to IDR
    function formatIDR(n){
      return 'Rp ' + Number(n).toLocaleString('id-ID');
    }

    function calc() {
      const budget = Math.max(17000, Number(document.getElementById('budget').value || 0));
      const durasi = Math.max(3, Number(document.getElementById('durasi').value || 0));

      // jasa setup rule
      let jasa = 0;
      if (durasi >= 3) {
        jasa = 50000; // starting for 3 days
        if (durasi > 3) {
          jasa += (durasi - 3) * 15000;
        }
      }

      const subtotal = budget * durasi;
      const total = subtotal + jasa;

      document.getElementById('jasaSetupText').value = formatIDR(jasa);
      document.getElementById('totalIklanText').value = formatIDR(subtotal);
      document.getElementById('totalAllText').value = formatIDR(total);

      return {budget, durasi, jasa, subtotal, total};
    }

    // Update calculations when inputs change
    ['budget','durasi'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => calc());
    });

    // Generate 4-digit invoice number
    function genInvoiceNumber(){
      return Math.floor(1000 + Math.random() * 9000).toString();
    }

    document.getElementById('btnPreview').addEventListener('click', function(){
      const form = document.getElementById('orderForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const {budget,durasi,jasa,subtotal,total} = calc();

      document.getElementById('pvNama').innerText = document.getElementById('nama').value;
      document.getElementById('pvPaket').innerText = document.getElementById('paket').value;
      document.getElementById('pvBudget').innerText = formatIDR(budget) + ' / hari';
      document.getElementById('pvDurasi').innerText = durasi + ' hari';
      document.getElementById('pvSubtotal').innerText = formatIDR(subtotal);
      document.getElementById('pvJasa').innerText = formatIDR(jasa);
      document.getElementById('pvTotal').innerText = formatIDR(total);

      const inv = genInvoiceNumber();
      document.getElementById('invoiceNumber').innerText = '#' + inv;
      document.getElementById('tanggalInvoice').innerText = new Date().toLocaleString('id-ID');

      // watermark toggle
      const wm = document.getElementById('wmText');
      wm.style.display = document.getElementById('showWatermark').checked ? 'block' : 'none';

      document.getElementById('previewArea').style.display = 'block';
      // scroll to preview
      document.getElementById('previewArea').scrollIntoView({behavior:'smooth'});
    });

    // Download PDF using html2canvas + jsPDF
    document.getElementById('btnDownloadPdf').addEventListener('click', async function(){
      const pv = document.getElementById('previewArea');
      // ensure preview shown and form valid
      const form = document.getElementById('orderForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      // Recreate preview to update invoice number and data
      document.getElementById('btnPreview').click();

      const invoiceEl = document.getElementById('invoice');

      // temporarily set a white background for canvas capture
      const originalBg = invoiceEl.style.background;
      invoiceEl.style.background = '#ffffff';

      // Use html2canvas
      const canvas = await html2canvas(invoiceEl, {scale: 2, useCORS: true});
      const imgData = canvas.toDataURL('image/jpeg', 0.9);

      // Create jsPDF and add image
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation: 'portrait', unit: 'pt', format: 'a4'});
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // Calculate image size to fit width
      const imgWidth = pageWidth - 40; // margins
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      pdf.addImage(imgData, 'JPEG', 20, 20, imgWidth, imgHeight);

      // Save (compressed) PDF
      pdf.save('Invoice_' + document.getElementById('invoiceNumber').innerText.replace('#','') + '.pdf');

      // restore
      invoiceEl.style.background = originalBg;
    });

    // Share (Web Share API) - share PDF blob if available
    document.getElementById('btnShare').addEventListener('click', async function(){
      const form = document.getElementById('orderForm');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      document.getElementById('btnPreview').click();
      const invoiceEl = document.getElementById('invoice');

      // capture
      const canvas = await html2canvas(invoiceEl, {scale: 2, useCORS: true});
      const imgData = canvas.toDataURL('image/jpeg', 0.9);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation: 'portrait', unit: 'pt', format: 'a4'});
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgWidth = pageWidth - 40;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      pdf.addImage(imgData, 'JPEG', 20, 20, imgWidth, imgHeight);

      const arrayBuf = pdf.output('arraybuffer');
      const blob = new Blob([arrayBuf], { type: 'application/pdf' });

      // Use Web Share if available
      if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'invoice.pdf', {type:'application/pdf'})] })) {
        const file = new File([blob], 'invoice.pdf', { type: 'application/pdf' });
        try {
          await navigator.share({ files: [file], title: 'Invoice Pemesanan', text: 'Invoice dari Lead Digital Marketing' });
        } catch (err) {
          alert('Gagal membagikan: ' + err.message);
        }
      } else {
        // Fallback: prompt download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'invoice.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        alert('Perangkat Anda tidak mendukung berbagi langsung. File PDF telah diunduh.');
      }
    });

    // initial calc
    calc();
  </script>
</body>
</html>
